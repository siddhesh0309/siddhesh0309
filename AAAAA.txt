import pandas as pd
import os
from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows
from glob import glob

# Paths
template_folder = "Templates"  # your folder with multiple templates
master_template = "master_template.xlsm"
output_file = "updated_master_template.xlsm"

# Collect data from all templates
all_rows = []
files = glob(os.path.join(template_folder, "*.xlsm"))

print("üì• Reading templates...")
for file in files:
    print(f"‚Üí {os.path.basename(file)}")
    df = pd.read_excel(file, sheet_name="Account Holder", skiprows=8, header=None, engine="openpyxl")
    headers = pd.read_excel(file, sheet_name="Account Holder", skiprows=3, nrows=1, engine="openpyxl").columns.tolist()
    df.columns = headers
    all_rows.append(df)

# Merge all rows
merged_df = pd.concat(all_rows, ignore_index=True)

# Load the master template (preserve macros)
print("‚úçÔ∏è Writing to master template...")
wb = load_workbook(master_template, keep_vba=True)
ws = wb["Account Holder"]

# Start writing from row 9
start_row = 9
for r_idx, row in enumerate(dataframe_to_rows(merged_df, index=False, header=False), start=start_row):
    for c_idx, value in enumerate(row, start=1):
        ws.cell(row=r_idx, column=c_idx, value=value)

# Save to new updated output
wb.save(output_file)
print(f"‚úÖ Master template updated and saved as {output_file}")
