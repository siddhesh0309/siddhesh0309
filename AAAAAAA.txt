import pandas as pd
import os
from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows
from glob import glob

# Paths
template_folder = "Templates"  # Folder with input templates
master_template = "master_template.xlsm"  # Master file with macros
output_file = "updated_master_template.xlsm"  # Final output file
mapping_file = "mapping.xlsx"  # Mapping file with Account Number and Customer ID

# Sheets to process with row settings
sheets = {
    "Account Holder": {"skiprows": 8},
    "Controlling Person": {"skiprows": 8}
}

# Store merged data
merged_data = {sheet: [] for sheet in sheets}

# Read mapping file
print("üìò Reading mapping file...")
mapping_df = pd.read_excel(mapping_file, usecols=["Account Number", "Customer ID"])
mapping_df = mapping_df.astype(str)  # Ensure string type for comparison
mapping_set = set(zip(mapping_df["Account Number"], mapping_df["Customer ID"]))

# Gather all template files
files = glob(os.path.join(template_folder, "*.xlsm"))

print("üì• Reading template files...")
for file in files:
    print(f"‚Üí Processing: {os.path.basename(file)}")

    for sheet_name, opts in sheets.items():
        try:
            df = pd.read_excel(file, sheet_name=sheet_name, skiprows=opts["skiprows"], header=None, engine="openpyxl")

            if df.empty:
                print(f"‚ö†Ô∏è Skipping '{sheet_name}' in {os.path.basename(file)} ‚Äî no data found after row 8.")
                continue

            headers = pd.read_excel(file, sheet_name=sheet_name, skiprows=3, nrows=1, engine="openpyxl").columns.tolist()

            if len(headers) != df.shape[1]:
                print(f"‚ö†Ô∏è Skipping '{sheet_name}' in {os.path.basename(file)} ‚Äî column count mismatch.")
                continue

            df.columns = headers
            merged_data[sheet_name].append(df)

        except Exception as e:
            print(f"‚ùå Error reading '{sheet_name}' in {os.path.basename(file)}: {e}")

# Load master template (preserve macros)
print("‚úçÔ∏è Loading master template...")
wb = load_workbook(master_template, keep_vba=True)

# Write merged data into each sheet
for sheet_name in sheets:
    if sheet_name not in wb.sheetnames:
        print(f"‚ùå Sheet '{sheet_name}' not found in master template. Skipping.")
        continue

    if not merged_data[sheet_name]:
        print(f"‚ÑπÔ∏è No data collected for '{sheet_name}'. Skipping.")
        continue

    ws = wb[sheet_name]
    start_row = 9  # Data starts from row 9

    # Combine all collected data for the sheet
    full_df = pd.concat(merged_data[sheet_name], ignore_index=True)

    # Add Status column based on mapping match
    if {"Account Number", "Customer ID"}.issubset(full_df.columns):
        full_df["Status"] = full_df.apply(
            lambda row: "TRUE" if (str(row["Account Number"]), str(row["Customer ID"])) in mapping_set else "FALSE",
            axis=1
        )
    else:
        print(f"‚ö†Ô∏è 'Account Number' and 'Customer ID' not found in '{sheet_name}', skipping Status column.")

    print(f"‚úçÔ∏è Writing {len(full_df)} rows to '{sheet_name}'...")
    for r_idx, row in enumerate(dataframe_to_rows(full_df, index=False, header=False), start=start_row):
        for c_idx, value in enumerate(row, start=1):
            ws.cell(row=r_idx, column=c_idx, value=value)

# Save the updated master file
wb.save(output_file)
print(f"‚úÖ Master template saved as '{output_file}'")
