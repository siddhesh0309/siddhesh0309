from pywinauto import Application
from pywinauto.keyboard import send_keys
from pywinauto.win32functions import SetForegroundWindow
from openpyxl import load_workbook
from PIL import ImageGrab
import easyocr
import time

# === CONFIG ===
edge_path = r"C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
url = "https://ewaybillgst.gov.in/ewb.html"
excel_path = "ewaybill_data.xlsx"
captcha_bbox = (950, 450, 1100, 480)  # Adjust if needed
max_captcha_attempts = 3

# === Launch Edge ===
app = Application(backend="uia").start(f'"{edge_path}" {url}')
time.sleep(6)

dlg = app.window(title_re=".*E Way Bill.*|.*ewaybillgst.*")
dlg.restore()
dlg.set_focus()
SetForegroundWindow(dlg.wrapper_object().handle)

# === Helper: Find textbox next to label ===
def enter_next_to_label(parent, label_text, value):
    all_controls = parent.descendants()
    for i, ctrl in enumerate(all_controls):
        if ctrl.window_text().strip() == label_text:
            for next_ctrl in all_controls[i+1:]:
                if next_ctrl.friendly_class_name() == "Edit":
                    next_ctrl.set_edit_text("")
                    next_ctrl.set_edit_text(str(value))
                    return True
    return False

# === Captcha Logic ===
reader = easyocr.Reader(['en'])

def solve_and_submit_captcha():
    # Bring focus again before screen capture
    dlg.set_focus()
    SetForegroundWindow(dlg.wrapper_object().handle)

    captcha_img = ImageGrab.grab(captcha_bbox)
    captcha_img.save("captcha.png")
    result = reader.readtext("captcha.png")
    captcha_text = result[0][1].strip() if result else ""

    # Find captcha box (assumed to be 5th Edit box)
    captcha_field = dlg.descendants(control_type="Edit")[4]
    captcha_field.set_edit_text("")
    captcha_field.set_edit_text(captcha_text)

    # Click GO button
    try:
        dlg.child_window(title="GO", control_type="Button").click()
    except:
        pass
    time.sleep(3)

    try:
        return dlg.child_window(title_re=".*Export.*").exists(timeout=2)
    except:
        return False

# === Load Excel ===
wb = load_workbook(excel_path)
ws = wb.active

# === Process each row ===
for row in ws.iter_rows(min_row=2, values_only=True):
    ewb_no, ewb_date, generated_by, doc_no = row
    print(f"\nProcessing EWB No: {ewb_no}")

    try:
        dlg.set_focus()
        SetForegroundWindow(dlg.wrapper_object().handle)

        enter_next_to_label(dlg, "Enter e-WayBill No.", ewb_no)
        enter_next_to_label(dlg, "Enter e-WayBill Date", ewb_date)
        enter_next_to_label(dlg, "Enter e-WayBill Generated by", generated_by)
        enter_next_to_label(dlg, "Document No.", doc_no)

        for attempt in range(max_captcha_attempts):
            print(f"  Captcha attempt {attempt + 1}")
            if solve_and_submit_captcha():
                print(f"  Success for EWB: {ewb_no}")
                screen = ImageGrab.grab()
                screen.save(f"result_{ewb_no}.png")
                break
            else:
                print("  Invalid captcha, retrying...")
        else:
            print(f"  Failed after {max_captcha_attempts} attempts")

    except Exception as e:
        print(f"  Error for EWB {ewb_no}: {e}")

    # Refresh the form for next entry
    send_keys('^r')  # Ctrl + R
    time.sleep(5)
