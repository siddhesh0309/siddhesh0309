
import pandas as pd
from pathlib import Path
from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows
from datetime import datetime
import re
import os

# Extract date for append from ZIP filename
zip_file_path = "VFIN_06May2024.zip"
date_for_append = Path(zip_file_path).stem.split("_")[1]

# Load Excel files
vfin_df = pd.read_excel("Vfin.xlsx")
buyfp_df = pd.read_excel("buyfp.xlsx")

vfin_df['Date'] = pd.to_datetime(vfin_df['Date'], errors='coerce')
buyfp_df['Date'] = pd.to_datetime(buyfp_df['Date'], errors='coerce')

# Normalize customer names
customer_group_map = {
    "arcemitthal il": "Arcemitthal",
    "arcemitthal lp": "Arcemitthal",
    "arcemitthal": "Arcemitthal",
    "badshah": "Badshah",
    "exotic fruit": "Exotic Fruit"
}
buyfp_df['Customer Normalized'] = (
    buyfp_df['Customer Name'].str.strip().str.lower()
    .map(customer_group_map)
    .fillna(buyfp_df['Customer Name'])
)

root_output = Path("Customer_Excels")
root_output.mkdir(exist_ok=True)

# Process each customer
for customer in buyfp_df['Customer Normalized'].dropna().unique():
    cust_buyfp = buyfp_df[buyfp_df['Customer Normalized'].str.lower() == customer.lower()].copy()
    if 'Customer Normalized' in cust_buyfp.columns:
        cust_buyfp.drop(columns=['Customer Normalized'], inplace=True)

    # Get sheet name from Date Approved column
    cust_buyfp['Date Approved'] = pd.to_datetime(cust_buyfp['Date Approved'], errors='coerce')
    valid_approval_dates = cust_buyfp['Date Approved'].dropna()

    if valid_approval_dates.empty:
        print(f"â ï¸ No valid Date Approved for {customer}")
        continue

    approval_date = valid_approval_dates.iloc[0]
    sheet_name = approval_date.strftime('%b-%Y')

    try:
        config_df = pd.read_excel("customer_config.xlsx", sheet_name=sheet_name)
    except Exception as e:
        print(f"â Cannot load sheet {sheet_name} from customer_config.xlsx: {e}")
        continue

    config = config_df[config_df['Customer'].str.lower().str.contains(customer.lower())]
    if config.empty:
        print(f"â ï¸ No config found for {customer} in sheet {sheet_name}")
        continue

    config = config.iloc[0]
    tbill, spread, tenor, roi = config['TBILL RATE'], config['SPREAD'], config['TENOR'], config['ROI']

    cust_buyfp['Rate'] = tbill + spread
    cust_buyfp['Interest Amount'] = round(cust_buyfp['Bill amount'] * cust_buyfp['Rate'] * tenor / 36500, 2)

    if "badshah" in customer.lower():
        cust_vfin = vfin_df[vfin_df['Customer Name'].str.lower().str.contains("badshah")].copy()
    elif "exotic fruit" in customer.lower():
        cust_vfin = vfin_df[vfin_df['Customer Name'].str.lower().str.contains("exotic fruit")].copy()
    elif "arcemitthal" in customer.lower():
        cust_vfin = vfin_df[vfin_df['Customer Name'].str.lower().str.contains("arcemitthal|arcemittal")].copy()
    else:
        cust_vfin = vfin_df[vfin_df['Customer Name'].str.lower().str.strip() == customer.lower().strip()].copy()

    cust_vfin['ROI'] = roi
    principal_col = 'Amount' if 'Amount' in cust_vfin.columns else 'Principal'
    cust_vfin['Interest Amount'] = round(cust_vfin[principal_col] * roi * 1 / 36500, 2)

    all_dates = pd.concat([cust_vfin["Date"], cust_buyfp["Date"]]).dropna()
    for period in all_dates.dt.to_period("M").unique():
        start = period.to_timestamp()
        end = start + pd.offsets.MonthEnd(0)

        vfin_month = cust_vfin[(cust_vfin["Date"] >= start) & (cust_vfin["Date"] <= end)]
        buyfp_month = cust_buyfp[(cust_buyfp["Date"] >= start) & (cust_buyfp["Date"] <= end)]

        year_str = start.strftime('%Y')
        month_str = start.strftime('%b')
        customer_dir = root_output / customer / year_str / month_str
        customer_dir.mkdir(parents=True, exist_ok=True)
        file_path = customer_dir / f"{customer}_{month_str}.xlsx"

        if not file_path.exists():
            with pd.ExcelWriter(file_path, engine='openpyxl') as writer:
                vfin_month.to_excel(writer, sheet_name="vfin", index=False)
                buyfp_month.to_excel(writer, sheet_name="buyfp", index=False)
            wb = load_workbook(file_path)
            ws = wb["vfin"]
            ws.insert_rows(1)
            ws.cell(row=1, column=1, value=date_for_append)
            wb.save(file_path)
        else:
            wb = load_workbook(file_path)
            if "vfin" in wb.sheetnames:
                sheet = wb["vfin"]
                sheet.append([date_for_append])
                for row in dataframe_to_rows(vfin_month, index=False, header=False):
                    sheet.append(row)
            if "buyfp" in wb.sheetnames:
                wb.remove(wb["buyfp"])
            with pd.ExcelWriter(file_path, engine='openpyxl', mode='a', if_sheet_exists='overlay') as writer:
                writer.book = wb
                buyfp_month.to_excel(writer, sheet_name="buyfp", index=False)
                writer.save()

# Delete original vfin file
try:
    os.remove("Vfin.xlsx")
    print("â Vfin.xlsx deleted successfully.")
except FileNotFoundError:
    print("â ï¸ Vfin.xlsx not found.")
except Exception as e:
    print(f"â Error deleting Vfin.xlsx: {e}")
