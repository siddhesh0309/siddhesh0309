from pywinauto import Application
from pywinauto.keyboard import send_keys
from openpyxl import load_workbook
import easyocr
from PIL import ImageGrab
import time

# Launch Edge in app mode
url = "https://ewaybillgst.gov.in/ewb.html"
app = Application(backend="uia").start(f'msedge --app={url}')
time.sleep(6)

# Connect to the window
dlg = app.window(title_re=".*E Way Bill Print.*")
dlg.set_focus()

# Load Excel
wb = load_workbook("ewaybill_data.xlsx")
ws = wb.active

# OCR reader
reader = easyocr.Reader(['en'])

def solve_and_submit_captcha():
    """Captures captcha, inputs, and clicks GO"""
    bbox = (950, 450, 1100, 480)  # Update if needed
    captcha_img = ImageGrab.grab(bbox)
    captcha_img.save("captcha.png")
    result = reader.readtext("captcha.png")
    captcha_text = result[0][1].strip() if result else ""

    captcha_field = dlg.child_window(control_type="Edit", found_index=4)
    captcha_field.set_edit_text("")  # Clear previous input
    time.sleep(0.5)
    captcha_field.set_edit_text(captcha_text)
    dlg.child_window(title="GO", control_type="Button").click()
    time.sleep(3)

    # Check if submission was successful
    try:
        # Example: presence of Export button or success message
        success = dlg.child_window(title_re=".*Export.*").exists(timeout=2)
        return success
    except:
        return False

# Process each row
for row in ws.iter_rows(min_row=2, values_only=True):
    ewb_no, ewb_date, generated_by, doc_no = row
    print(f"Processing: {ewb_no}")

    try:
        # Enter form fields only once
        dlg.child_window(title="Enter e-WayBill No.", control_type="Edit").set_edit_text(str(ewb_no))
        dlg.child_window(title="Enter e-WayBill Date", control_type="Edit").set_edit_text(str(ewb_date))
        dlg.child_window(title="Enter e-WayBill Generated by", control_type="Edit").set_edit_text(str(generated_by))
        dlg.child_window(title="Document No.", control_type="Edit").set_edit_text(str(doc_no))

        # Retry captcha up to 3 times
        for attempt in range(3):
            print(f"Attempt {attempt + 1} - solving captcha...")
            if solve_and_submit_captcha():
                print(f"Success: {ewb_no}")
                screen = ImageGrab.grab()
                screen.save(f"result_{ewb_no}.png")
                break
            else:
                print("Captcha failed. Retrying...")
        else:
            print(f"Failed after 3 attempts: {ewb_no}")

    except Exception as e:
        print(f"Error for {ewb_no}: {e}")

    # Refresh for next row
    send_keys('^r')  # Ctrl+R to refresh
    time.sleep(5)
